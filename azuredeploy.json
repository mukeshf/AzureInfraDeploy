{
  "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "tagBillingIdentifier": {
      "type": "string",
      "metadata": {
        "description": "BillingIdentifier tag."
      }
    },
    "accessPolicies": {
      "defaultValue": { "list": [] }
      "type": "object"
    },
    "kvtSkuName": {
      "type": "string",
      "defaultValue": "Standard",
      "allowedValues": [
        "Standard",
        "Premium"
      ],
      "metadata": {
        "description": "SKU for the vault"
      }
    },
    "kvtEnabledForDeployment": {
      "type": "bool",
      "allowedValues": [
        true,
        false
      ],
      "defaultValue": false,
      "metadata": {
        "description": "set TRUE to enable access for deployments"
      }
    },
    "kvtEnabledForTemplateDeployment": {
      "type": "bool",
      "allowedValues": [
        true,
        false
      ],
      "defaultValue": false,
      "metadata": {
        "description": "set TRUE to enable access for Template deployments"
      }
    },
    "kvtEnabledForDiskEncryption": {
      "type": "bool",
      "allowedValues": [
        true,
        false
      ],
      "defaultValue": false,
      "metadata": {
        "description": "set TRUE to enable access for disk encryption"
      }
    },
    "kvtObjectId": {
      "type": "string",
      "metadata": {
        "description": "ObjectId of Pipeline account"
      }
    },
    "kvtTenantId": {
      "type": "string",
      "metadata": {
        "description": "TenantID required for deployment to control access"
      }
    },
    "kvtObjectIdAdmin": {
      "type": "string",
      "metadata": {
        "description": "ObjectId of Admin account"
      }
    }
  },
  "variables": {
    
    "resourcegroupName": "[resourceGroup().name]",

    "customerNameLong": "[split(variables('resourcegroupName'),'-')[0]]",
    "customerName": "[if(greater(length(variables('customerNameLong')), 10 ), substring(variables('customerNameLong'), 0, 10), variables('customerNameLong'))]",

    "applicationNameLong": "[split(variables('resourcegroupName'),'-')[2]]",
    "applicationName": "[if(greater(length(variables('applicationNameLong')), 10 ), substring(variables('applicationNameLong'), 0, 10), variables('applicationNameLong'))]",

    "environment": "[split(variables('resourcegroupName'),'-')[3]]",
    "kvtName": "[toLower(concat(variables('customerName'),'kv',variables('applicationName'),variables('environment')))]"

  },
  "resources": [
    {
      "name": "[variables('kvtName')]",
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2016-10-01",
      "location": "[resourceGroup().location]",
      "tags": {
        "TemplateVersion": "tagTemplateVersion",
        "EnvironmentType": "parameters('tagEnvironmentType')",
        "BillingIdentifier": "parameters('tagBillingIdentifier')"
      },
      "properties": {

        "enabledForDeployment": "[parameters('kvtEnabledForDeployment')]",
        "enabledForDiskEncryption": "[parameters('kvtEnabledForDiskEncryption')]",
        "enabledForTemplateDeployment": "[parameters('kvtEnabledForTemplateDeployment')]",
        "accessPolicies": "[parameters('accessPolicies').list]",
        "sku": {
          "name": "[parameters('kvtSkuName')]",
          "family": "A"
        },
        "tenantId": "[parameters('kvtTenantId')]"
      }
    }
  ],
  "outputs": {
    "kvtName": {
      "type": "string",
      "value": "[variables('kvtName')]"
    },
    "kvtResourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.KeyVault/vaults', variables('kvtName'))]"
    },
    "kvtUri": {
      "type": "string",
      "value": "[reference(variables('kvtName')).VaultUri]"
    }
  }
}
